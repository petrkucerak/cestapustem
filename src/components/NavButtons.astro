---
import { getCollection } from "astro:content";
import Button from "./Button.astro";
import Card from "./Card.astro";

// Fetch the collection of pages
const pagesData = await getCollection("den");
const setkaniData = await getCollection("setkani");

// Extract slugs (dates) from pagesData
const availablePages = pagesData.map((page) => page.slug);
const availableSetkani = setkaniData.map((page) => ({
  slug: page.slug,
  dayName: page.data.dayName,
  imgPath: page.data.imgPath,
  imgAlt: page.data.imgAlt,
  startDate: page.data.startDate,
  imagePositionY: page.data.imagePositionY,
}));
---

<!-- <h2 class="mx-6 mt-4 font-semibold">Čtení se zamyšlením</h2> -->
<div
  id="navigation-buttons"
  class="mx-6 flex flex-row justify-around mt-8 mb-4"
  data-pages={JSON.stringify(availablePages)}
  data-setkani={JSON.stringify(availableSetkani)}
>
  <!-- Navigation buttons hidden by default -->
  <Button
    id="yesterday-button"
    href="#"
    className="hidden bg-primary-light shadow"
    target="_self"
    content="VČERA"
  />
  <Button
    id="today-button"
    href="#"
    className="hidden bg-primary-dark shadow"
    target="_self"
    content="DNES"
  />
  <Button
    id="tomorrow-button"
    href="#"
    className="hidden bg-primary-light shadow"
    target="_self"
    content="ZÍTRA"
  />
</div>

<!-- <h2 class="mx-6 font-semibold mb-2">Metodika pro setkání společenství</h2>
<div class="mx-6
  flex
  flex-row
  justify-center
  flex-wrap">
  <Card
    id="setkani-card"
    href="#"
    content={`Materiály pro setkání`}
    imagePath={`/covers/webp/1_nedele_postni.webp`}
    imageAlt={`Setkání pro 1_nedele_postni`}
    imagePositionY={53}
    className="hidden"
  />
</div> -->

<script>
  // @ts-nocheck
  // Function to format a date into yyyy-mm-dd
  const formatDate = (date) => date.toISOString().split("T")[0];

  // Get today, yesterday, and tomorrow
  const today = new Date();
  const yesterday = new Date(today);
  const tomorrow = new Date(today);

  yesterday.setDate(today.getDate() - 1);
  tomorrow.setDate(today.getDate() + 1);

  const dates = {
    yesterday: formatDate(yesterday),
    today: formatDate(today),
    tomorrow: formatDate(tomorrow),
  };

  // Get available pages from the data attribute
  const availablePages = new Set(
    JSON.parse(document.getElementById("navigation-buttons").dataset.pages),
  );

  // Check if a page is available
  const isPageAvailable = (date) => availablePages.has(date);

  // Update buttons if corresponding pages exist
  const updateButton = (id, date) => {
    const button = document.getElementById(id);
    if (isPageAvailable(date)) {
      button.href = `/den/${date}`;
      button.classList.remove("hidden");
    }
  };

  // Run the update for each button
  updateButton("yesterday-button", dates.yesterday);
  updateButton("today-button", dates.today);
  updateButton("tomorrow-button", dates.tomorrow);

  const availableSetkani = JSON.parse(
    document.getElementById("navigation-buttons").dataset.setkani,
  );

  // Find the setkani record closest to today (but not in the future)
  let closestSetkani = null;
  let closestDifference = Infinity;

  availableSetkani.forEach((setkani) => {
    const startDate = new Date(setkani.startDate);
    const difference = today - startDate;

    // Only consider dates that are today or in the past
    if (difference >= 0 && difference < closestDifference) {
      closestDifference = difference;
      closestSetkani = setkani;
    }
  });

  // Update the Card if a setkani record was found
  if (closestSetkani) {
    const cardElement = document.getElementById("setkani-card");
    if (cardElement) {
      cardElement.href = `/setkani/${closestSetkani.slug}`;
      cardElement.querySelector("p").textContent = closestSetkani.dayName;
      cardElement.querySelector("img").src = closestSetkani.imgPath;
      cardElement.querySelector("img").alt = closestSetkani.imgAlt;
      cardElement.querySelector("img").style.objectPosition =
        `center ${closestSetkani.imagePositionY}%`;
      // Only remove hidden class if navigation buttons are also visible
      if (
        document
          .getElementById("yesterday-button")
          .classList.contains("hidden") &&
        document.getElementById("today-button").classList.contains("hidden") &&
        document.getElementById("tomorrow-button").classList.contains("hidden")
      ) {
        // All buttons are hidden, keep card hidden
      } else {
        // At least one button is visible, show the card
        cardElement.classList.remove("hidden");
      }
    }
  }
</script>
