---
import { getCollection } from "astro:content";

// === KONFIGURACE – stačí změnit rok ===
const rok = 2026;

// === Výpočet Velikonoc (zjednodušený Gaussův algoritmus pro západní křesťanství) ===
function vypocitejVelikonoce(y) {
  const a = y % 19;
  const b = Math.floor(y / 100);
  const c = y % 100;
  const d = Math.floor((19 * a + b - Math.floor(b / 4) - Math.floor((b - Math.floor((b + 8) / 25) + 1) / 3) + 15) % 30);
  const e = Math.floor((32 + 2 * (b % 4) + 2 * Math.floor(c / 4) - d - (c % 4)) % 7);
  const f = d + e - 7 * Math.floor((a + 11 * d + 22 * e) / 451) + 114;
  const mesic = Math.floor(f / 31);
  const den = (f % 31) + 1;
  return new Date(y, mesic - 1, den);
}

const velikonoce = vypocitejVelikonoce(rok);
const popelecniStreda = new Date(velikonoce);
popelecniStreda.setDate(velikonoce.getDate() - 46);

// === Vytvoření sekcí ===
const sekceDefinice = [];

let aktualni = new Date(popelecniStreda);

// 1. Popeleční středa → sobota (samostatná sekce, často jen 1–4 dny)
let sobotaPoPopleci = new Date(popelecniStreda);
sobotaPoPopleci.setDate(popelecniStreda.getDate() + (6 - popelecniStreda.getDay() + 7) % 7);
sekceDefinice.push({
  nazev: "Týden popeleční středy",
  start: popelecniStreda,
  end: sobotaPoPopleci,
});

// Pak 1.–5. postní neděle + týden po nich (neděle → sobota)
for (let i = 1; i <= 5; i++) {
  let nedela = new Date(sobotaPoPopleci);
  nedela.setDate(nedela.getDate() + 1); // neděle po předchozí sobotě
  let dalsiSobota = new Date(nedela);
  dalsiSobota.setDate(nedela.getDate() + 6);
  sekceDefinice.push({
    nazev: `${i}. postní týden`,
    start: nedela,
    end: dalsiSobota,
  });
  sobotaPoPopleci = dalsiSobota;
}

// Svatý týden = Květná neděle → Velikonoční sobota
const kvetnaNedela = new Date(velikonoce);
kvetnaNedela.setDate(velikonoce.getDate() - 7);
const velikononiSobota = new Date(velikonoce);
velikononiSobota.setDate(velikonoce.getDate() - 1);

sekceDefinice.push({
  nazev: "Svatý týden",
  start: kvetnaNedela,
  end: velikononiSobota,
});

// === Načtení a seskupení dnů ===
const days = await getCollection("den");

const postniSekce = sekceDefinice.map((sek) => {
  const dnyVSekci = days
    .filter((day) => {
      const d = new Date(day.data.date);
      return d >= sek.start && d <= sek.end;
    })
    .sort((a, b) => new Date(a.data.date) - new Date(b.data.date));

  return {
    nazev: sek.nazev,
    dny: dnyVSekci.map((day) => {
      const date = new Date(day.data.date);
      const denVTydnu = date.toLocaleDateString("cs-CZ", { weekday: "short" }).toUpperCase();
      return {
        id: day.data.date,
        display: date.getDate(),
        den: denVTydnu,
        getDay: date.getDay(),
      };
    }),
  };
}).filter((s) => s.dny.length > 0);

// Vypočítat offset pro první den celého kalendáře (hlavička PO=1 .. NE=0)
const prvniDen = postniSekce[0]?.dny[0];
const offset = prvniDen ? ((prvniDen.getDay - 1 + 7) % 7) : 0;
---

<div class="mx-6 my-8">
  <h2 class="text-2xl font-bold uppercase mb-4">Postní kalendář {rok}</h2>

  <div class="space-y-4">
    <!-- Dny v týdnu jako hlavička gridu -->
    <div class="grid grid-cols-7 gap-2 mb-3 text-xs font-semibold text-gray-500 text-center">
      <div>PO</div><div>ÚT</div><div>ST</div><div>ČT</div><div>PÁ</div><div>SO</div><div>NE</div>
    </div>

    <!-- Jediná mřížka pro všechny sekce -->
    <div class="grid grid-cols-7 gap-2">
      <!-- Offset prázdných buněk na začátku -->
      {Array.from({ length: offset }).map(() => (
        <div class="aspect-square"></div>
      ))}

      {postniSekce.map((sekce) => (
        <>
          <!-- Nadpis sekce jako full-span řádek -->
          <div class="col-span-7 font-bold text-lg text-center py-2  border-gray-200 mt-2">
            {sekce.nazev}
          </div>

          <!-- Dny sekce -->
          {sekce.dny.map((den) => (
            <a
              href={`/den/${den.id}`}
              class="aspect-square flex flex-col items-center justify-center rounded-lg
                     text-center font-medium text-base transition duration-150
                     border border-gray-200"
              data-den={den.id}
            >
              <span class="text-xs text-gray-500">{den.den}</span>
              <span class="text-lg">{den.display}</span>
            </a>
          ))}
        </>
      ))}
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const today = new Date().toISOString().split("T")[0];
    let precitane = JSON.parse(localStorage.getItem("precitaneDny") || "[]");

    document.querySelectorAll("a[data-den]").forEach((link) => {
      const denId = link.dataset.den;

      // Aktuální den
      if (denId === today) {
        link.classList.add(
          "bg-blue-100",
          "border-blue-400",
          "text-blue-800",
          "font-bold",
          "shadow-sm"
        );
      }

      // Přečtené
      if (precitane.includes(denId)) {
        link.classList.add("opacity-60", "grayscale");
      }

      // Označení po kliku
      link.addEventListener("click", () => {
        if (!precitane.includes(denId)) {
          precitane.push(denId);
          localStorage.setItem("precitaneDny", JSON.stringify(precitane));
          link.classList.add("opacity-60", "grayscale");
        }
      });
    });
  });
</script>